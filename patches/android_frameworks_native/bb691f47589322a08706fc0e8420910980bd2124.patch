From bb691f47589322a08706fc0e8420910980bd2124 Mon Sep 17 00:00:00 2001
From: Pavel Kirpichyov <pavel.kirpichyov@gmail.com>
Date: Mon, 17 Dec 2012 12:51:35 +0400
Subject: [PATCH] Simplify HWC and FB hal check

Change-Id: I6879dbb53b301e40ded36ccf3c8d93abd66a257d
---
 .../surfaceflinger/DisplayHardware/HWComposer.cpp  |   21 ++++----
 simplify.diff                                      |   53 ++++++++++++++++++++
 2 files changed, 63 insertions(+), 11 deletions(-)
 create mode 100644 simplify.diff

diff --git a/services/surfaceflinger/DisplayHardware/HWComposer.cpp b/services/surfaceflinger/DisplayHardware/HWComposer.cpp
index 690ec8d..53743e0 100644
--- a/services/surfaceflinger/DisplayHardware/HWComposer.cpp
+++ b/services/surfaceflinger/DisplayHardware/HWComposer.cpp
@@ -233,17 +233,16 @@ struct HWComposer::cb_context {
     loadFbHalModule();
     loadHwcModule();
 
-    if (mFbDev && mHwc && hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1)) {
-        // close FB HAL if we don't needed it.
-        // FIXME: this is temporary until we're not forced to open FB HAL
-        // before HWC.
-        framebuffer_close(mFbDev);
-        mFbDev = NULL;
-    }
-
-    // If we have no HWC, or a pre-1.1 HWC, an FB dev is mandatory.
-    if ((!mHwc || !hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1))
-            && !mFbDev) {
+    if (mHwc && hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1)) {
+	if (mFbDev) {
+            // close FB HAL if we don't needed it.
+            // FIXME: this is temporary until we're not forced to open FB HAL
+            // before HWC.
+            framebuffer_close(mFbDev);
+            mFbDev = NULL;
+	}
+    } else if (!mFbDev) {
+	// If we have no HWC, or a pre-1.1 HWC, an FB dev is mandatory.
         ALOGE("ERROR: failed to open framebuffer, aborting");
         abort();
     }
diff --git a/simplify.diff b/simplify.diff
new file mode 100644
index 0000000..69b380d
--- /dev/null
+++ b/simplify.diff
@@ -0,0 +1,53 @@
+From 0508ff39d54d820bc3f6584db17579d66d3729ae Mon Sep 17 00:00:00 2001
+From: Pavel Kirpichyov <pavel.kirpichyov@gmail.com>
+Date: Wed, 28 Nov 2012 13:35:32 +0400
+Subject: [PATCH] Simplify HWC and FB hal check
+
+Change-Id: I0d005e3bb092b75ba281b89bb4e86d534f7f23de
+---
+ .../surfaceflinger/DisplayHardware/HWComposer.cpp  |   22 +++++++++-----------
+ 1 file changed, 10 insertions(+), 12 deletions(-)
+
+diff --git a/services/surfaceflinger/DisplayHardware/HWComposer.cpp b/services/surfaceflinger/DisplayHardware/HWComposer.cpp
+index 31d731e..5578716 100644
+--- a/services/surfaceflinger/DisplayHardware/HWComposer.cpp
++++ b/services/surfaceflinger/DisplayHardware/HWComposer.cpp
+@@ -113,17 +113,16 @@ HWComposer::HWComposer(
+     loadFbHalModule();
+     loadHwcModule();
+ 
+-    if (mFbDev && mHwc && hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1)) {
+-        // close FB HAL if we don't needed it.
+-        // FIXME: this is temporary until we're not forced to open FB HAL
+-        // before HWC.
+-        framebuffer_close(mFbDev);
+-        mFbDev = NULL;
+-    }
+-
+-    // If we have no HWC, or a pre-1.1 HWC, an FB dev is mandatory.
+-    if ((!mHwc || !hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1))
+-            && !mFbDev) {
++    if (mHwc && hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_1)) {
++	if (mFbDev) {
++            // close FB HAL if we don't needed it.
++            // FIXME: this is temporary until we're not forced to open FB HAL
++            // before HWC.
++            framebuffer_close(mFbDev);
++            mFbDev = NULL;
++	}
++    } else if (!mFbDev) {
++	// If we have no HWC, or a pre-1.1 HWC, an FB dev is mandatory.
+         ALOGE("ERROR: failed to open framebuffer, aborting");
+         abort();
+     }
+@@ -232,7 +231,6 @@ void HWComposer::loadHwcModule()
+               HWC_HARDWARE_COMPOSER, strerror(-err));
+         return;
+     }
+-
+     if (!hwcHasApiVersion(mHwc, HWC_DEVICE_API_VERSION_1_0) ||
+             hwcHeaderVersion(mHwc) < MIN_HWC_HEADER_VERSION ||
+             hwcHeaderVersion(mHwc) > HWC_HEADER_VERSION) {
+-- 
+1.7.10.4
+
-- 
1.7.10

